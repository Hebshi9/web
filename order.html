<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة العميل - سلس</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'tajawal': ['Tajawal', 'sans-serif'],
                    },
                    colors: {
                        'sals-primary': '#1e40af',
                        'sals-secondary': '#3b82f6',
                        'sals-accent': '#f59e0b',
                        'sals-dark': '#1f2937',
                        'sals-light': '#f8fafc'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
        }
        .timeline {
            position: relative;
        }
        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            right: 20px;
            height: 100%;
            width: 2px;
            background: #e5e7eb;
        }
        .timeline-item {
            position: relative;
            padding-right: 60px;
            margin-bottom: 30px;
        }
        .timeline-icon {
            position: absolute;
            right: 8px;
            top: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 1;
        }
        .timeline-icon.active {
            background: #1e40af;
            color: white;
        }
        .timeline-icon.completed {
            background: #10b981;
            color: white;
        }
        .timeline-icon.pending {
            background: #e5e7eb;
            color: #6b7280;
        }
        .floating-whatsapp {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .message-bubble {
            max-width: 70%;
            margin-bottom: 15px;
        }
        .message-bubble.client {
            margin-right: auto;
            margin-left: 0;
        }
        .message-bubble.admin {
            margin-left: auto;
            margin-right: 0;
        }
    </style>
</head>
<body class="bg-gray-50 font-tajawal">
    <!-- Floating WhatsApp Button -->
    <a href="https://wa.me/966503678789" target="_blank" class="floating-whatsapp">
        <div class="bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition-colors">
            <i class="fab fa-whatsapp text-2xl"></i>
        </div>
    </a>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-4xl font-bold text-sals-primary mb-4">سلس</div>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sals-primary mx-auto mb-4"></div>
            <p class="text-gray-600">جاري تحميل بيانات طلبك...</p>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="errorScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50 hidden">
        <div class="text-center max-w-md mx-auto p-6">
            <div class="text-red-500 text-6xl mb-4">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">عذراً، لم نتمكن من العثور على طلبك</h2>
            <p class="text-gray-600 mb-6">يرجى التأكد من صحة الرابط أو التواصل معنا للمساعدة</p>
            <div class="flex gap-4 justify-center">
                <a href="index.html" class="bg-sals-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    العودة للرئيسية
                </a>
                <a href="https://wa.me/966503678789" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                    تواصل معنا
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-sals-primary">بوابة العميل - سلس</h1>
                        <p class="text-gray-600 mt-1">مرحباً <span id="customerName" class="font-medium">---</span> - تتبع حالة طلبك وتواصل مع فريقنا</p>
                    </div>
                    <div class="text-left">
                        <p class="text-sm text-gray-600">رقم الطلب</p>
                        <p class="font-bold text-sals-dark" id="orderNumber">---</p>
                    </div>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Order Progress -->
                <div class="lg:col-span-2">
                    <!-- Order Summary -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">ملخص الطلب</h2>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-bold text-gray-700 mb-3">تفاصيل الباقة</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>الباقة:</span>
                                        <span id="packageName" class="font-medium">---</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>السعر الأساسي:</span>
                                        <span id="basePrice" class="font-medium">--- ر.س</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>الخدمات الإضافية:</span>
                                        <span id="additionalServices" class="font-medium">---</span>
                                    </div>
                                    <div class="flex justify-between border-t pt-2">
                                        <span class="font-bold">المجموع الكلي:</span>
                                        <span id="totalPrice" class="font-bold text-sals-primary">--- ر.س</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-gray-700 mb-3">معلومات الطلب</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>تاريخ الطلب:</span>
                                        <span id="orderDate" class="font-medium">---</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>الحالة الحالية:</span>
                                        <span id="currentStatus" class="font-medium px-3 py-1 rounded-full text-sm">---</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>المسؤول:</span>
                                        <span id="assignedTo" class="font-medium">---</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">مراحل تنفيذ الطلب</h2>
                        
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-icon completed">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">تم استلام الطلب</h3>
                                    <p class="text-gray-600 text-sm">تم استلام طلبك بنجاح وسيتم مراجعته قريباً</p>
                                    <p class="text-xs text-gray-500 mt-1" id="receivedDate">---</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-icon" id="reviewIcon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">مراجعة المتطلبات</h3>
                                    <p class="text-gray-600 text-sm">يتم مراجعة متطلباتك وتحديد أفضل الحلول</p>
                                    <p class="text-xs text-gray-500 mt-1" id="reviewDate">في الانتظار</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-icon" id="workIcon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">العمل على الطلب</h3>
                                    <p class="text-gray-600 text-sm">فريقنا يعمل على إنجاز طلبك بأعلى جودة</p>
                                    <p class="text-xs text-gray-500 mt-1" id="workDate">في الانتظار</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-icon" id="deliveryIcon">
                                    <i class="fas fa-gift"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">تسليم الطلب</h3>
                                    <p class="text-gray-600 text-sm">تسليم العمل النهائي والمراجعات المطلوبة</p>
                                    <p class="text-xs text-gray-500 mt-1" id="deliveryDate">في الانتظار</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">التواصل المباشر</h2>
                        
                        <div id="messagesContainer" class="h-64 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-comments text-3xl mb-2"></i>
                                <p>لا توجد رسائل حتى الآن</p>
                                <p class="text-sm">ابدأ محادثة مع فريقنا</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا..." class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-sals-primary focus:border-transparent">
                            <button onclick="sendMessage()" class="bg-sals-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Contact Info -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">معلومات التواصل</h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center ml-3">
                                    <i class="fab fa-whatsapp text-green-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium">واتساب</p>
                                    <p class="text-sm text-gray-600">+966503678789</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3">
                                    <i class="fas fa-envelope text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium">البريد الإلكتروني</p>
                                    <p class="text-sm text-gray-600">info@sals.sa</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <a href="https://wa.me/966503678789" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                                <i class="fab fa-whatsapp ml-2"></i>
                                تواصل عبر واتساب
                            </a>
                        </div>
                    </div>

                    <!-- Resources Library -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">مكتبة الموارد</h3>
                        
                        <div class="space-y-3">
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
                                <div class="w-8 h-8 bg-red-100 rounded flex items-center justify-center ml-3">
                                    <i class="fas fa-file-pdf text-red-600 text-sm"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-sm">دليل كتابة السيرة الذاتية</p>
                                    <p class="text-xs text-gray-500">PDF - 2.5 MB</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
                                <div class="w-8 h-8 bg-blue-100 rounded flex items-center justify-center ml-3">
                                    <i class="fas fa-file-word text-blue-600 text-sm"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-sm">نماذج خطابات التغطية</p>
                                    <p class="text-xs text-gray-500">DOCX - 1.2 MB</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
                                <div class="w-8 h-8 bg-green-100 rounded flex items-center justify-center ml-3">
                                    <i class="fas fa-video text-green-600 text-sm"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-sm">نصائح للمقابلات الشخصية</p>
                                    <p class="text-xs text-gray-500">فيديو - 15 دقيقة</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <p class="text-xs text-gray-500">المزيد من الموارد ستكون متاحة قريباً</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/firebase-config.js"></script>
    <script src="js/client-portal.js"></script>
    
    <script>
    // Override client-portal.js to use our backend API
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderData();
    });

    async function loadOrderData() {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        if (!orderId) {
            showError();
            return;
        }

        const apiUrl = `https://5000-is20x6ners704x6gl1at6-16b15953.manusvm.computer/api/orders/${orderId}`;

        // Try primary API with timeout, then fallback to local db.json for Netlify previews
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 6000);
            const response = await fetch(apiUrl, { signal: controller.signal, mode: 'cors' });
            clearTimeout(timeoutId);

            if (response.ok) {
                const order = await response.json();
                displayOrderData(order);
                return;
            }
        } catch (error) {
            console.warn('Primary API failed. Falling back to static db.json', error);
        }

        // Fallback: use static db.json (works on Netlify deploy previews)
        try {
            const localResponse = await fetch('db.json', { cache: 'no-cache' });
            if (!localResponse.ok) throw new Error('db.json not accessible');
            const db = await localResponse.json();
            const order = (db.orders || []).find(o => o.id === orderId);
            if (order) {
                displayOrderData(order);
                return;
            }
            showError();
        } catch (fallbackError) {
            console.error('Fallback failed:', fallbackError);
            showError();
        }
    }

    function displayOrderData(order) {
        if (!order) { showError(); return; }
        // Hide loading screen
        document.getElementById('loadingScreen').classList.add('hidden');
        
        // Show main content
        document.getElementById('mainContent').classList.remove('hidden');

        // Fill order information
        document.getElementById('orderNumber').textContent = order.id || 'غير محدد';
        document.getElementById('customerName').textContent = order.personalInfo?.fullName || 'العميل';
        document.getElementById('packageName').textContent = order.packageName || 'غير محدد';
        document.getElementById('basePrice').textContent = `${order.basePrice || 0} ر.س`;
        document.getElementById('totalPrice').textContent = `${order.totalPrice || 0} ر.س`;
        
        // Additional services
        let additionalServices = [];
        if (order.upsellServices?.coverLetter) additionalServices.push('خطاب التغطية');
        if (order.upsellServices?.interviewPrep) additionalServices.push('محاكاة المقابلة');
        document.getElementById('additionalServices').textContent = additionalServices.length > 0 ? additionalServices.join(', ') : 'لا يوجد';

        // Order date
        const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('ar-SA') : 'غير محدد';
        document.getElementById('orderDate').textContent = orderDate;
        document.getElementById('receivedDate').textContent = orderDate;

        // Status
        const status = order.status || 'جديد';
        const statusElement = document.getElementById('currentStatus');
        statusElement.textContent = status;
        statusElement.className = `font-medium px-3 py-1 rounded-full text-sm ${getStatusClass(status)}`;

        // Assigned to
        document.getElementById('assignedTo').textContent = order.assignedTo || 'غير مسند بعد';

        // Update timeline based on status
        updateTimeline(status);
    }

    function updateTimeline(status) {
        const reviewIcon = document.getElementById('reviewIcon');
        const workIcon = document.getElementById('workIcon');
        const deliveryIcon = document.getElementById('deliveryIcon');

        // Reset all icons
        reviewIcon.className = 'timeline-icon pending';
        workIcon.className = 'timeline-icon pending';
        deliveryIcon.className = 'timeline-icon pending';

        if (status === 'قيد التنفيذ' || status === 'مكتمل') {
            reviewIcon.className = 'timeline-icon completed';
            document.getElementById('reviewDate').textContent = 'تم';
        }

        if (status === 'قيد التنفيذ') {
            workIcon.className = 'timeline-icon active';
            document.getElementById('workDate').textContent = 'جاري العمل';
        }

        if (status === 'مكتمل') {
            workIcon.className = 'timeline-icon completed';
            deliveryIcon.className = 'timeline-icon completed';
            document.getElementById('workDate').textContent = 'تم';
            document.getElementById('deliveryDate').textContent = 'تم التسليم';
        }
    }

    function getStatusClass(status) {
        switch (status) {
            case 'جديد': return 'bg-blue-100 text-blue-800';
            case 'قيد التنفيذ': return 'bg-yellow-100 text-yellow-800';
            case 'مكتمل': return 'bg-green-100 text-green-800';
            case 'ملغي': return 'bg-red-100 text-red-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function showError() {
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('errorScreen').classList.remove('hidden');
    }

    // Message functionality (placeholder)
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (message) {
            // For now, just show an alert
            alert('تم إرسال رسالتك. سيتم الرد عليك قريباً عبر واتساب.');
            messageInput.value = '';
        }
    }

    // Enter key support for message input
    document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    </script>
</body>
</html>

